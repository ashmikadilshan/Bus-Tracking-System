<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Real-Time Bus Tracking</title>
  <link rel="stylesheet" href="style.css">
  <!-- Leaflet Map Library -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head>
<body>
  <h2>ðŸšŒ Real-Time Bus Tracking System</h2>
  <div id="map"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const SUPABASE_URL = "https://qkobfoeypazszftbnkmb.supabase.co"
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFrb2Jmb2V5cGF6c3pmdGJua21iIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4Njc1MzAsImV4cCI6MjA3NjQ0MzUzMH0.AdkoAaSAL-RK6kH3fTa7vKf5gLNkS03qqp8XvR97ccE"
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY)

    // Initialize map
    const map = L.map('map').setView([6.9271, 79.8612], 13) // starting view (Colombo)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map)

    const busMarkers = {}

    // Fetch initial bus data
    async function loadInitialData() {
      const { data } = await supabase.from('locations').select('*')
      data.forEach(updateBusMarker)
    }

    // Update or add a bus marker on the map
    function updateBusMarker(bus) {
      const { bus_id, latitude, longitude } = bus
      if (busMarkers[bus_id]) {
        busMarkers[bus_id].setLatLng([latitude, longitude])
      } else {
        const marker = L.marker([latitude, longitude]).addTo(map)
        marker.bindPopup(`<b>${bus_id}</b>`)
        busMarkers[bus_id] = marker
      }
    }

    // Subscribe to realtime updates
    supabase
      .channel('bus-locations')
      .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'locations' }, (payload) => {
        updateBusMarker(payload.new)
      })
      .subscribe()

    loadInitialData()
  </script>
</body>
</html>
